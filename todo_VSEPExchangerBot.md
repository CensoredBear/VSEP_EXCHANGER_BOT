# ToDo VSEPExchangerBot

## Исправления и улучшения

### 2025-01-27 - Исправлена проблема с заполнением столбцов D, H, K в Google Sheets
- **Проблема**: При выполнении команды `/transfer` в Excel таблицу не заполнялись столбцы D (Note), H (Курс обмена), K (Реквизиты)
- **Причина**: В коде использовались неправильные названия полей базы данных:
  - `transaction.get('used_rate', 0)` вместо `transaction.get('rate_used', 0)`
  - `transaction.get('acc_info', '')` вместо `transaction.get('account_info', '')`
- **Исправления**:
  - В файле `handlers.py` строка 1601: заменил `used_rate` на `rate_used`
  - В файле `handlers.py` строка 1604: заменил `acc_info` на `account_info`
  - Обновил комментарии в коде для соответствия реальным названиям полей
- **Результат**: Теперь при выполнении `/transfer` все столбцы записываются корректно

### 2025-01-27 - Исправлена проблема с пустыми заметками в столбце D
- **Проблема**: В столбце D (Note) часто были пустые значения, хотя при командах `/control` почти всегда есть примечания
- **Причина**: При выборе заявки на контроль через кнопки note не сохранялся в базу данных
- **Исправления**:
  - В файле `handlers.py` в функции `control_callback_handler`: добавлено сохранение `crm_number` в поле `note` при обновлении статуса на "control"
  - Добавлено логирование для отладки сохранения note
- **Результат**: Теперь при выборе заявки на контроль через кнопки note сохраняется в базу данных и корректно отображается в Excel таблице

### 2025-01-27 - Исправлены ошибки типизации в google_sync.py
- **Проблема**: Ошибки Pylance в файле `google_sync.py` - несовместимость типов `SecretStr` и `str`
- **Причина**: `config.BOT_TOKEN` имеет тип `SecretStr`, но конструктор `Bot` ожидает `str`
- **Исправления**:
  - В файле `google_sync.py` строка 107: `Bot(token=config.BOT_TOKEN)` → `Bot(token=str(config.BOT_TOKEN))`
  - В файле `google_sync.py` строка 174: `Bot(token=config.BOT_TOKEN)` → `Bot(token=str(config.BOT_TOKEN))`
- **Результат**: Устранены ошибки типизации Pylanceолняются корректно:
  - D: Note (заметки к транзакции)
  - H: Курс обмена (реальный курс, использованный в транзакции)
  - K: Реквизиты (информация о банковских реквизитах)
- **Файлы изменены**: `handlers.py`, `google_sync.py`

## 2024-06-09

- [x] **Динамическое help-меню по статусу пользователя**
  - Описание: Сделать так, чтобы команда /help показывала только те команды, которые доступны пользователю по его статусу (user, operator, admin, superadmin) и ниже.
  - Статусы определяются автоматически по данным бота.
  - Алгоритм:
    1. Определять статус пользователя при вызове /help
    2. Формировать help-меню только с доступными командами
    3. Тестировать для всех статусов
    4. После подтверждения — внедрить в основной обработчик
  - Статусы:
    - user
    - operator
    - admin
    - superadmin
  - открыто: 2024-06-09
  - выполнено: 2024-06-09

- [x] **Реализовать рассылку SOS по команде /sos**
  - Описание: При вызове /sos бот отправляет яркое сообщение в группу админов и всем пользователям со статусом оператор, админ, суперадмин в личку. В сообщении — название чата и кликабельная ссылка на сообщение.
  - открыто: 2024-06-09 19:10
  - выполнено: 2024-06-09 19:15

- [x] **Универсальная функция отправки сообщений и функция времени**
  - Описание: Реализовать универсальную функцию send_message для отправки любых сообщений (обычное, с автоудалением, ответ, пересылка, с задержкой и т.д.) и функцию get_bali_and_msk_time_str для вставки времени в сообщения. Использовать по всему проекту.
  - открыто: 2024-06-09 19:20
  - выполнено: 2024-06-09 19:25

- [x] **Модуль логирования истории чатов**
  - Описание: Реализовать отдельный модуль chat_logger.py для логирования всей истории переписки в чатах (отправка, редактирование, удаление, пересылка, вложения и т.д.) с эмодзи и временем. Логи писать в APP\VSEPExchangerBot\logs\vsep_bot.log
  - открыто: 2024-06-09 19:30
  - выполнено: 2024-06-09 19:35

- [x] 2024-06-10 03:00 — Добавлено правило: все действия и правки фиксировать в TODO-файле с датой и временем. Зафиксирована структура данных для Google Sheets (A, B, C, D, H, I, J, K, L; E). 

## 2025-06-21

- [x] **Переход на универсальные media_id и исправление ошибок**
  - Описание: Произведен рефакторинг системы отправки медиафайлов. Бот переведен с использования локальных файлов и `photo_id` на универсальные `media_id`, которые могут представлять как фото, так и видео/анимацию.
  - Проблемы:
    - Ошибки `ValidationError` и `TelegramBadRequest` при отправке медиа.
    - Использование жестко закодированных путей к локальным видеофайлам для оповещений о смене.
    - Устаревшая и дублирующаяся логика отправки медиа в разных частях кода.
  - Решение:
    1. Поля в БД и в `SystemSettings` переименованы с `photo_id_*` на `media_*` (`media_start`, `media_finish`, `media_mbt`).
    2. Создана новая универсальная функция `utils.safe_send_media_with_caption` для безопасной отправки любого типа медиа по `file_id`. Функция обрабатывает ошибки и имеет фолбэк на текстовое сообщение.
    3. Старая функция `safe_send_photo_with_caption` и дублирующая логика из `procedures/input_sum.py` удалены.
    4. Команды для установки медиа обновлены на `/set_media_start`, `/set_media_finish`, `/set_media_mbt`.
    5. Модули `scheduler.py` и `procedures/input_sum.py` обновлены для использования новых настроек и новой функции отправки.
  - Файлы изменены:
    - `utils.py` - новая универсальная функция отправки медиа.
    - `config.py` - обновлены поля в `SystemSettings`.
    - `db.py` - изменена логика получения настроек.
    - `handlers.py` - новые команды `/set_media_*`.
    - `scheduler.py` - убрана зависимость от локальных файлов, используется `media_start`/`media_finish`.
    - `procedures/input_sum.py` - используется `media_mbt` и новая функция отправки.
    - `help_menu.py` - обновлен текст помощи.
  - Результат: Устранены ошибки при отправке медиа. Повышена гибкость системы (теперь можно использовать видео/анимации для всех оповещений). Код стал чище и централизованнее.
  - открыто: 2025-06-21
  - выполнено: 2025-06-21

## Структура данных в Google Sheets
- Колонки A, B, C, D, H, I, J, K, L используются для записи данных.
- Каждая строка представляет собой транзакцию.
- Данные включают:
  - Номер транзакции
  - Сумму в IDR
  - Сумму в RUB
  - Курс обмена
  - Статус
  - Реквизиты
  - Временные метки
  - Информацию о пользователе
  - Историю изменений
- В колонку E нужно поставить чекбокс-флаг для дальнейшего его заполнения (квадратик для галочки). 